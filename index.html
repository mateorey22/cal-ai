<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitalis AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- Variables et thème --- */
        :root {
            --font-sans: 'Inter', sans-serif;
            --color-primary: #22c55e;
            --color-primary-translucent: rgba(34, 197, 94, 0.1);
            --color-secondary: #3b82f6;
            --color-secondary-translucent: rgba(59, 130, 246, 0.1);
            --color-accent: #f59e0b;
            --background-dark: #0c0a09;
            --background-glass-dark: rgba(28, 25, 23, 0.25);
            --text-primary-dark: #f5f5f4;
            --text-secondary-dark: #a8a29e;
            --text-tertiary-dark: #78716c;
            --border-dark: rgba(245, 245, 244, 0.2);
            --border-subtle-dark: rgba(245, 245, 244, 0.1);
            --background-light: #f8fafc;
            --background-glass-light: rgba(255, 255, 255, 0.4);
            --text-primary-light: #1c1917;
            --text-secondary-light: #57534e;
            --text-tertiary-light: #a8a29e;
            --border-light: rgba(28, 25, 23, 0.1);
            --border-subtle-light: rgba(28, 25, 23, 0.05);
        }

        .dark {
            --color-background: var(--background-dark);
            --color-background-glass: var(--background-glass-dark);
            --color-text-primary: var(--text-primary-dark);
            --color-text-secondary: var(--text-secondary-dark);
            --color-text-tertiary: var(--text-tertiary-dark);
            --color-border: var(--border-dark);
            --color-border-subtle: var(--border-subtle-dark);
        }

        .light {
            --color-background: var(--background-light);
            --color-background-glass: var(--background-glass-light);
            --color-text-primary: var(--text-primary-light);
            --color-text-secondary: var(--text-secondary-light);
            --color-text-tertiary: var(--text-tertiary-light);
            --color-border: var(--border-light);
            --color-border-subtle: var(--border-subtle-light);
        }

        /* --- Global & Base Styling --- */
        *, *::before, *::after { box-sizing: border-box; }

        body {
            background-color: var(--color-background);
            font-family: var(--font-sans);
            margin: 0;
            overscroll-behavior: none;
            transition: background-color 0.5s ease;
        }

        /* Utilisation de `flex` pour un ajustement mobile plus robuste */
        .app-container {
            max-width: 480px;
            margin: auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            color: var(--color-text-primary);
        }
        
        /* Animation de fond liquide avec gyroscope */
        .glass-bg-container {
            position: absolute;
            inset: -10%; /* L'agrandir pour éviter de couper les bords lors de la rotation */
            background-image: radial-gradient(circle at 10% 20%, var(--color-primary-translucent), transparent 50%),
                              radial-gradient(circle at 80% 90%, var(--color-secondary-translucent), transparent 50%);
            z-index: -1;
            transition: background-image 0.5s ease, opacity 0.5s ease;
            transform: translate(var(--bg-x, 0), var(--bg-y, 0)); /* Utilisé par JS pour le gyroscope */
            filter: hue-rotate(var(--hue-rotate, 0deg)); /* Effet de réflexion/reflet */
        }

        /* Assurer un défilement fluide et masquer la barre de défilement */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem 1rem 7rem 1rem;
            -webkit-overflow-scrolling: touch;
        }
        .main-content::-webkit-scrollbar { width: 0; background: transparent; }

        /* Animations de transition d'écran */
        .screen { display: none; animation: slideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .screen.active { display: block; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .screen-title { font-size: 2.25rem; font-weight: 800; margin-bottom: 1.5rem; color: var(--color-text-primary); }
        .section-title { font-weight: 600; margin-bottom: 0.75rem; color: var(--color-text-secondary); }

        /* Ombre et transition pour les cartes de verre */
        .glass-card { 
            background-color: var(--color-background-glass); 
            backdrop-filter: blur(24px); 
            -webkit-backdrop-filter: blur(24px); 
            border: 1px solid var(--color-border); 
            border-radius: 1.25rem; 
            transition: background-color 0.3s, border 0.3s, box-shadow 0.3s ease; 
            padding: 1rem; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .glass-card:hover { box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); }
        .input, .select { background-color: var(--color-background-glass); border: 1px solid var(--color-border); border-radius: 1rem; padding: 0.85rem 1rem; width: 100%; color: var(--color-text-primary); transition: all 0.2s ease; font-size: 1rem; font-family: var(--font-sans); }
        .input:focus, .select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-translucent); }
        .select { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23a8a29e' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .btn { padding: 0.75rem 1.25rem; border-radius: 1rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); border: none; font-family: var(--font-sans); }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-secondary { background-color: var(--color-border); color: var(--color-text-primary); }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.875rem; border-radius: 0.75rem; }
        
        /* --- Dashboard Screen --- */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .dashboard-card { padding: 1rem; }
        .dashboard-card.full-width { grid-column: 1 / -1; }
        .card-title { font-weight: 600; font-size: 1rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .calorie-progress { position: relative; width: 120px; height: 120px; margin: auto; }
        .progress-circle-bg, .progress-circle-fg { fill: none; stroke-width: 12; }
        .progress-circle-bg { stroke: var(--color-border); }
        .progress-circle-fg { stroke: var(--color-primary); stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.5s ease; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .progress-text .calories { font-size: 1.75rem; font-weight: 800; line-height: 1; }
        .progress-text .label { font-size: 0.75rem; color: var(--color-text-secondary); }
        .hydration-tracker { display: flex; justify-content: space-around; align-items: center; }
        .water-glass { cursor: pointer; color: var(--color-text-tertiary); transition: color 0.2s; }
        .water-glass.filled { color: var(--color-secondary); }

        /* --- Nutrition Screen --- */
        .meal-log-list { display: flex; flex-direction: column; gap: 1rem; }
        .meal-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; }
        .meal-item-icon { width: 48px; height: 48px; flex-shrink: 0; background-color: var(--color-border-subtle); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; }
        .meal-item-icon img { width: 100%; height: 100%; object-fit: cover; border-radius: 0.75rem; }
        .meal-item-details { flex-grow: 1; }
        .meal-item-name { font-weight: 600; }
        .meal-item-macros { font-size: 0.875rem; color: var(--color-text-secondary); display: flex; gap: 0.75rem; }
        .meal-item-calories { font-weight: 600; font-size: 1.125rem; }
        #meal-image-preview { max-width: 100%; max-height: 200px; border-radius: 1rem; margin-bottom: 1rem; }
        .or-divider { display: flex; align-items: center; text-align: center; color: var(--color-text-tertiary); margin: 1rem 0; }
        .or-divider::before, .or-divider::after { content: ''; flex: 1; border-bottom: 1px solid var(--color-border); }
        .or-divider:not(:empty)::before { margin-right: .5em; }
        .or-divider:not(:empty)::after { margin-left: .5em; }

        /* --- Workout Screen --- */
        .workout-program-list { display: flex; flex-direction: column; gap: 1rem; }
        .program-card { display: flex; flex-direction: column; gap: 0.5rem; cursor: pointer; }
        .program-card-header { display: flex; justify-content: space-between; align-items: center; }
        .program-title { font-size: 1.125rem; font-weight: 600; }
        .program-tags { display: flex; gap: 0.5rem; }
        .tag { font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0.5rem; border-radius: 0.5rem; }
        .tag-green { background-color: var(--color-primary-translucent); color: var(--color-primary); }
        .tag-blue { background-color: var(--color-secondary-translucent); color: var(--color-secondary); }
        .program-description { color: var(--color-text-secondary); font-size: 0.9rem; }
        .ai-generator-section { display: flex; flex-direction: column; gap: 1rem; }

        /* --- Progress Screen --- */
        .chart-container { height: 16rem; margin-top: 1rem; }

        /* --- Profile Screen --- */
        .settings-section { margin-bottom: 2rem; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; }
        .profile-form .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        
        /* --- Bottom Nav --- */
        .bottom-nav { 
            position: absolute; 
            left: 1rem; 
            right: 1rem; 
            bottom: 1rem; 
            height: 4.5rem; 
            padding: .75rem; 
            background-color: var(--color-background-glass); 
            backdrop-filter: blur(24px); 
            -webkit-backdrop-filter: blur(24px); 
            border: 1px solid var(--color-border); 
            display: flex; 
            border-radius: 1.25rem; 
            justify-content: space-around; 
            z-index: 10; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            transition: box-shadow 0.3s ease;
        }
        .nav-item { 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 0.25rem; 
            color: var(--color-text-tertiary); 
            background: none; 
            border: none; 
            cursor: pointer; 
            padding: 0.5rem; 
            border-radius: 0.5rem; 
            transition: all 0.2s ease; 
            width: 70px; 
            flex-grow: 1; 
        }
        .nav-item:hover, .nav-item.active { color: var(--color-primary); }
        .nav-label { font-size: 0.75rem; font-weight: 600; }
        .active-indicator { 
            position: absolute; 
            bottom: -10px; 
            height: 4px; 
            width: 24px; 
            background-color: var(--color-primary); 
            border-radius: 2px; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        /* --- Modals & Overlays --- */
        .modal-backdrop, .loading-overlay, .error-banner-container { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(10px); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-backdrop.visible, .loading-overlay.visible, .error-banner-container.visible { opacity: 1; visibility: visible; }
        .modal-content { max-width: 400px; width: 90%; text-align: left; max-height: 80vh; display: flex; flex-direction: column; }
        .modal-body { overflow-y: auto; padding: 0 0.5rem 0.5rem 0; }
        .error-banner-container { align-items: flex-end; padding: 1rem; padding-bottom: 6.5rem; background: none; backdrop-filter: none; pointer-events: none; }
        .error-banner-container.visible { pointer-events: auto; }
        .error-banner { width: 100%; max-width: 464px; margin: auto; background-color: #be123c; color: white; padding: 0.75rem 1rem; border-radius: 1.25rem; display: flex; align-items: center; gap: 0.75rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.4); transform: translateY(20px); transition: transform 0.3s; }
        .error-banner-container.visible .error-banner { transform: translateY(0); }
        .loading-overlay { z-index: 200; backdrop-filter: blur(4px); }
        .loading-content { display: flex; flex-direction: column; align-items: center; gap: 1rem; padding: 2rem; border-radius: 1.5rem; }
        .loading-content .icon-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* --- Camera Modal --- */
        #camera-modal { z-index: 110; }
        .camera-container { position: relative; width: 100%; max-width: 480px; aspect-ratio: 3/4; background-color: #000; border-radius: 1.25rem; overflow: hidden; }
        #camera-feed { width: 100%; height: 100%; object-fit: cover; }
        #capture-btn { position: absolute; bottom: 1.5rem; left: 50%; transform: translateX(-50%); width: 64px; height: 64px; border-radius: 50%; background-color: white; border: 4px solid rgba(255,255,255,0.5); }
        #close-camera-btn { position: absolute; top: 1rem; right: 1rem; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; padding: 0.5rem; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="app" class="app-container">
        <!-- Conteneur pour l'effet de fond animé -->
        <div class="glass-bg-container"></div>
        <main class="main-content">
            <!-- Accueil Screen -->
            <div id="screen-accueil" class="screen active">
                <div class="dashboard-header" style="margin-bottom: 1.5rem;">
                    <p class="text-lg text-text-secondary" id="dashboard-greeting">Bonjour, Matéo</p>
                    <h1 class="screen-title" style="margin-bottom: 0;">Votre Journée</h1>
                </div>
                <div class="dashboard-grid">
                    <div class="dashboard-card glass-card full-width">
                        <div class="card-title"><i data-lucide="flame" style="color:var(--color-accent)"></i>Aperçu Nutritionnel</div>
                        <div style="display: flex; align-items: center; justify-content: space-around;">
                            <div class="calorie-progress">
                                <svg viewBox="0 0 100 100">
                                    <circle class="progress-circle-bg" cx="50" cy="50" r="42"></circle>
                                    <circle id="calorie-progress-fg" class="progress-circle-fg" cx="50" cy="50" r="42" stroke-dasharray="264" stroke-dashoffset="264"></circle>
                                </svg>
                                <div class="progress-text">
                                    <span id="calories-consumed" class="calories">0</span>
                                    <div class="label">/ <span id="calories-goal">2000</span> kcal</div>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem; text-align: center;">
                                <div class="macro-item"><p id="carbs-consumed" class="value">0g</p><p class="label">Glucides</p></div>
                                <div class="macro-item"><p id="protein-consumed" class="value">0g</p><p class="label">Protéines</p></div>
                                <div class="macro-item"><p id="fat-consumed" class="value">0g</p><p class="label">Lipides</p></div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card glass-card">
                        <div class="card-title"><i data-lucide="dumbbell" style="color:var(--color-primary)"></i>Entraînement</div>
                        <div id="daily-workout-summary">
                            <p class="text-text-secondary" style="font-size: 0.9rem;">Aucun programme sélectionné.</p>
                            <button class="btn btn-primary btn-sm" style="width:100%; margin-top: 1rem;" data-screen-target="entrainement">Choisir un programme</button>
                        </div>
                    </div>

                    <div class="dashboard-card glass-card">
                        <div class="card-title"><i data-lucide="droplets" style="color:var(--color-secondary)"></i>Hydratation</div>
                        <div id="hydration-tracker" class="hydration-tracker">
                            <!-- JS will generate glasses -->
                        </div>
                        <p id="hydration-label" class="text-text-secondary" style="font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">0 / 8 verres</p>
                    </div>
                    
                    <div class="dashboard-card glass-card full-width">
                        <div class="card-title"><i data-lucide="sparkles" style="color:var(--color-primary)"></i>Coach du Jour</div>
                        <p id="coach-summary-text" class="text-text-secondary" style="font-size: 0.9rem;">Ajoutez des repas et un entraînement pour obtenir votre bilan IA.</p>
                        <button id="daily-coach-btn" class="btn btn-secondary" style="width: 100%; margin-top: 1rem;">Générer le Bilan</button>
                    </div>
                </div>
            </div>

            <!-- Nutrition Screen -->
            <div id="screen-nutrition" class="screen">
                <h1 class="screen-title">Nutrition</h1>
                <div id="add-meal-section">
                    <h2 class="section-title">Ajouter un Repas</h2>
                    <div class="glass-card" style="padding:1.5rem; display:flex; flex-direction:column; gap:1rem;">
                        <button id="open-camera-btn" class="btn btn-primary" style="width: 100%;"><i data-lucide="camera"></i> Scanner avec l'appareil photo</button>
                        <label for="meal-image-input" class="btn btn-secondary" style="width: 100%;"><i data-lucide="upload-cloud"></i> Importer une image</label>
                        <input type="file" id="meal-image-input" accept="image/*" style="display: none;">
                        <img id="meal-image-preview" src="" style="display: none;" alt="Aperçu du repas">
                        <button id="analyze-btn" class="btn btn-secondary" style="width: 100%;" disabled><i data-lucide="zap"></i> Analyser le Repas</button>
                        <div class="or-divider">ou</div>
                        <form id="manual-add-form" style="display: flex; flex-direction: column; gap: 1rem;">
                            <input type="text" id="manual-name" class="input" placeholder="Nom du plat">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <input type="number" id="manual-calories" class="input" placeholder="Calories">
                                <input type="number" id="manual-protein" class="input" placeholder="Protéines (g)">
                                <input type="number" id="manual-carbs" class="input" placeholder="Glucides (g)">
                                <input type="number" id="manual-fat" class="input" placeholder="Lipides (g)">
                            </div>
                            <button type="submit" class="btn btn-secondary" style="width: 100%;">Ajouter manuellement</button>
                        </form>
                    </div>
                </div>
                <div id="meal-log-section" style="margin-top: 2rem;">
                    <h2 class="section-title">Repas du jour</h2>
                    <div id="meal-log-list" class="meal-log-list">
                        <p id="empty-log-message" class="text-text-tertiary" style="text-align: center; padding: 2rem 0;">Aucun repas ajouté aujourd'hui.</p>
                    </div>
                </div>
            </div>

            <!-- Entraînement Screen -->
            <div id="screen-entrainement" class="screen">
                <h1 class="screen-title">Entraînement</h1>
                <!-- NOUVEAU: Section pour la génération de programme par IA -->
                <div id="ai-workout-section" class="glass-card" style="margin-bottom: 1.5rem; padding: 1.5rem; display:flex; flex-direction:column; gap:1rem;">
                    <h2 class="section-title" style="margin-bottom: 0;">Générer un programme AI</h2>
                    <select id="workout-objective-input" class="select">
                        <option value="gain-muscle">Prise de masse musculaire</option>
                        <option value="lose-weight">Perte de poids</option>
                        <option value="improve-cardio">Améliorer le cardio</option>
                    </select>
                    <button id="open-workout-camera-btn" class="btn btn-primary" style="width: 100%;"><i data-lucide="camera"></i> Scanner mon équipement</button>
                    <label for="workout-image-input" class="btn btn-secondary" style="width: 100%;"><i data-lucide="upload-cloud"></i> Importer une photo de mon équipement</label>
                    <input type="file" id="workout-image-input" accept="image/*" style="display: none;">
                    <img id="workout-image-preview" src="" style="display: none; max-width: 100%; max-height: 200px; border-radius: 1rem;">
                    <button id="generate-workout-btn" class="btn btn-secondary" style="width: 100%;" disabled><i data-lucide="zap"></i> Générer mon programme</button>
                </div>

                <div id="active-program-display" class="glass-card" style="margin-bottom: 1.5rem; display:none;">
                    <!-- JS will populate this -->
                </div>
                <h2 class="section-title">Programmes Disponibles</h2>
                <div id="workout-program-list" class="workout-program-list">
                    <!-- JS will generate programs -->
                </div>
            </div>

            <!-- Progrès Screen -->
            <div id="screen-progres" class="screen">
                <h1 class="screen-title">Vos Progrès</h1>
                <div class="glass-card" style="margin-bottom: 1.5rem;">
                    <h2 class="section-title">Évolution du poids (kg)</h2>
                    <div class="chart-container">
                        <canvas id="weight-chart"></canvas>
                    </div>
                </div>
                <div class="glass-card">
                    <h2 class="section-title">Activité Hebdomadaire</h2>
                    <div class="chart-container">
                        <canvas id="activity-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Profil Screen -->
            <div id="screen-profil" class="screen">
                <h1 class="screen-title">Profil & Paramètres</h1>
                <div class="settings-section">
                    <h2 class="section-title">Profil & Objectifs</h2>
                    <form id="profile-form" class="glass-card profile-form">
                        <div class="form-grid">
                            <div class="form-group"><label for="age">Âge</label><input id="age" type="number" class="input" value="18"></div>
                            <div class="form-group"><label for="gender">Sexe</label><select id="gender" class="select"><option value="male">Homme</option><option value="female">Femme</option></select></div>
                            <div class="form-group"><label for="height">Taille (cm)</label><input id="height" type="number" class="input" placeholder="ex: 180"></div>
                            <div class="form-group"><label for="weight">Poids (kg)</label><input id="weight" type="number" class="input" placeholder="ex: 75"></div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;"><label for="target-weight">Objectif Poids (kg)</label><input id="target-weight" type="number" class="input" placeholder="ex: 72"></div>
                        <div class="form-group" style="margin-top: 1rem;"><label for="activity-level">Niveau d'activité</label><select id="activity-level" class="select"><option value="1.2">Sédentaire</option><option value="1.375">Léger</option><option value="1.55" selected>Modéré</option><option value="1.725">Actif</option><option value="1.9">Très actif</option></select></div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;"><i data-lucide="save"></i> Mettre à jour le profil</button>
                    </form>
                </div>
                <div class="settings-section">
                    <h2 class="section-title">Configuration</h2>
                    <div class="glass-card" style="padding: 1rem; display:flex; flex-direction:column; gap:1rem;">
                        <div class="settings-item" style="padding: 0;"><span>Thème</span><button id="theme-toggle-btn" class="btn btn-secondary"><i data-lucide="sun"></i><span>Passer en Clair</span></button></div>
                        <form id="api-key-form" style="display:flex; flex-direction:column; gap:0.75rem; margin-top:1rem; border-top:1px solid var(--color-border-subtle); padding-top:1rem;">
                            <label style="font-weight:600; display:flex; align-items:center; gap:0.5rem;"><i data-lucide="key-round"></i> Clé API Gemini</label>
                            <input id="apiKeyInput" type="password" class="input" placeholder="Entrez votre clé API Google AI">
                            <button type="submit" class="btn btn-secondary" style="width:100%;"><span id="save-key-btn-text">Sauvegarder</span></button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-screen="accueil"><i data-lucide="home"></i><span class="nav-label">Accueil</span></button>
            <button class="nav-item" data-screen="nutrition"><i data-lucide="utensils-crossed"></i><span class="nav-label">Nutrition</span></button>
            <button class="nav-item" data-screen="entrainement"><i data-lucide="dumbbell"></i><span class="nav-label">Entraînement</span></button>
            <button class="nav-item" data-screen="progres"><i data-lucide="trending-up"></i><span class="nav-label">Progrès</span></button>
            <button class="nav-item" data-screen="profil"><i data-lucide="user"></i><span class="nav-label">Profil</span></button>
            <div class="active-indicator"></div>
        </nav>
    </div>

    <!-- Modals and Overlays -->
    <div id="camera-modal" class="modal-backdrop"><div class="camera-container"><video id="camera-feed" playsinline></video><button id="capture-btn"></button><button id="close-camera-btn"><i data-lucide="x"></i></button></div></div>
    <canvas id="camera-canvas" style="display:none;"></canvas>
    <div id="coach-modal" class="modal-backdrop"><div class="modal-content glass-card" style="padding: 1.5rem;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;"><h2 style="font-size:1.25rem; font-weight:bold; margin:0; color: var(--color-primary);">Coach du Jour</h2><button id="close-coach-modal-btn" style="background:none; border:none; color: var(--color-text-primary); cursor:pointer;"><i data-lucide="x"></i></button></div><div id="coach-modal-content" class="modal-body"></div></div></div>
    <div id="api-key-modal" class="modal-backdrop"><div class="modal-content glass-card" style="padding: 1.5rem; text-align:center;"><i data-lucide="key-round" style="margin:auto; display:block; color:var(--color-primary); margin-bottom:1rem; width:40px; height:40px;"></i><h2 style="font-size:1.25rem; font-weight:bold; margin-bottom:0.5rem;">Clé API Gemini Requise</h2><p style="color:var(--color-text-secondary); margin-bottom:1rem;">Pour utiliser les fonctions IA, veuillez entrer votre clé API Google AI.</p><form id="modal-api-key-form" style="display:flex; flex-direction:column; gap:0.75rem;"><input id="modal-api-key-input" type="password" placeholder="Entrez votre clé API ici" class="input" style="text-align:center;" autofocus><button type="submit" class="btn btn-primary" style="width: 100%;" disabled>Sauvegarder et continuer</button></form></div></div>
    <div id="workout-modal" class="modal-backdrop"><div id="workout-modal-content" class="modal-content glass-card" style="padding: 1.5rem;"></div></div>
    <div id="loading-overlay" class="loading-overlay"><div class="loading-content glass-card"><i data-lucide="loader-2" class="icon-spin" style="width:32px; height:32px; color:var(--color-primary);"></i><p id="loading-message">L'IA analyse votre plat...</p></div></div>
    <div id="error-banner-container" class="error-banner-container"><div class="error-banner"><i data-lucide="alert-circle"></i><p id="error-message"></p><button id="error-close-btn"><i data-lucide="x"></i></button></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const app = {
            state: {
                profile: { age: 18, gender: 'male', height: 180, weight: 75, targetWeight: 72, activityLevel: 1.55, tdee: 0 },
                weightLog: [], // { date, weight }
                nutritionLog: [], // { id, name, calories, protein, carbs, fat, image, date }
                workoutLog: [], // { date, programId, workoutName }
                hydration: { glasses: 0, goal: 8 },
                activeProgramId: null,
                activeScreen: 'accueil',
                theme: 'dark',
                apiKey: null,
                cameraStream: null,
            },
            
            // Les instances de Chart.js ne sont pas stockées dans le state pour éviter les erreurs de sérialisation.
            charts: {},

            // Base de données des programmes d'entraînement prédéfinis
            workoutPrograms: [
                {
                    id: 'pm-debutant',
                    title: 'Prise de Masse Débutant',
                    description: 'Un programme complet sur 3 jours pour construire une base musculaire solide.',
                    tags: [{text:'Force', class:'green'}, {text:'3 jours/sem', class:'blue'}],
                    schedule: {
                        1: { name: 'Pectoraux & Triceps', exercises: ['Développé couché: 3x8-12', 'Écarté incliné: 3x12-15', 'Dips: 3x max', 'Barre au front: 3x10-12'] },
                        3: { name: 'Dos & Biceps', exercises: ['Tractions: 3x max', 'Rowing barre: 3x8-12', 'Tirage vertical: 3x12-15', 'Curl biceps: 3x10-12'] },
                        5: { name: 'Jambes & Épaules', exercises: ['Squat: 3x8-12', 'Presse à cuisses: 3x12-15', 'Leg extension: 3x15', 'Développé militaire: 3x10-12', 'Élévations latérales: 3x15'] }
                    }
                },
                {
                    id: 'pdg-cardio',
                    title: 'Perte de Poids & Cardio',
                    description: 'Maximisez la dépense calorique avec ce mix de cardio et de renforcement.',
                    tags: [{text:'Cardio', class:'blue'}, {text:'4 jours/sem', class:'green'}],
                    schedule: {
                        1: { name: 'Circuit Full Body A', exercises: ['Pompes: 3x15', 'Squats sautés: 3x20', 'Gainage: 3x 1min', 'Burpees: 3x10', 'Course: 20min'] },
                        2: { name: 'Cardio Modéré', exercises: ['Vélo elliptique: 45min', 'Étirements: 10min'] },
                        4: { name: 'Circuit Full Body B', exercises: ['Fentes: 3x15/jambe', 'Mountain climbers: 3x45s', 'Kettlebell swing: 3x20', 'Jumping jacks: 3x1min', 'Corde à sauter: 15min'] },
                        5: { name: 'HIIT', exercises: ['Sprints: 8x 30s course / 1min repos', 'Étirements: 10min'] }
                    }
                }
            ],

            elements: {
                root: document.documentElement,
                screens: document.querySelectorAll('.screen'),
                navItems: document.querySelectorAll('.nav-item'),
                activeNavIndicator: document.querySelector('.active-indicator'),
                bgContainer: document.querySelector('.glass-bg-container'),
                
                // Accueil
                dashboardGreeting: document.getElementById('dashboard-greeting'),
                caloriesConsumed: document.getElementById('calories-consumed'),
                caloriesGoal: document.getElementById('calories-goal'),
                calorieProgressFg: document.getElementById('calorie-progress-fg'),
                carbsConsumed: document.getElementById('carbs-consumed'),
                proteinConsumed: document.getElementById('protein-consumed'),
                fatConsumed: document.getElementById('fat-consumed'),
                dailyWorkoutSummary: document.getElementById('daily-workout-summary'),
                hydrationTracker: document.getElementById('hydration-tracker'),
                hydrationLabel: document.getElementById('hydration-label'),
                dailyCoachBtn: document.getElementById('daily-coach-btn'),
                coachSummaryText: document.getElementById('coach-summary-text'),

                // Nutrition
                openCameraBtn: document.getElementById('open-camera-btn'),
                mealImageInput: document.getElementById('meal-image-input'),
                mealImagePreview: document.getElementById('meal-image-preview'),
                analyzeBtn: document.getElementById('analyze-btn'),
                manualAddForm: document.getElementById('manual-add-form'),
                mealLogList: document.getElementById('meal-log-list'),
                emptyLogMessage: document.getElementById('empty-log-message'),

                // Entraînement
                workoutProgramList: document.getElementById('workout-program-list'),
                activeProgramDisplay: document.getElementById('active-program-display'),
                openWorkoutCameraBtn: document.getElementById('open-workout-camera-btn'),
                workoutImageInput: document.getElementById('workout-image-input'),
                workoutImagePreview: document.getElementById('workout-image-preview'),
                generateWorkoutBtn: document.getElementById('generate-workout-btn'),
                workoutObjectiveInput: document.getElementById('workout-objective-input'),

                // Progrès
                weightChartCanvas: document.getElementById('weight-chart'),
                activityChartCanvas: document.getElementById('activity-chart'),

                // Profil
                profileForm: document.getElementById('profile-form'),
                ageInput: document.getElementById('age'),
                genderInput: document.getElementById('gender'),
                heightInput: document.getElementById('height'),
                weightInput: document.getElementById('weight'),
                targetWeightInput: document.getElementById('target-weight'),
                activityLevelInput: document.getElementById('activity-level'),
                themeToggleBtn: document.getElementById('theme-toggle-btn'),
                apiKeyForm: document.getElementById('api-key-form'),
                apiKeyInput: document.getElementById('apiKeyInput'),
                saveKeyBtnText: document.getElementById('save-key-btn-text'),
                
                // Modals & Overlays
                cameraModal: document.getElementById('camera-modal'),
                cameraFeed: document.getElementById('camera-feed'),
                cameraCanvas: document.getElementById('camera-canvas'),
                captureBtn: document.getElementById('capture-btn'),
                closeCameraBtn: document.getElementById('close-camera-btn'),
                coachModal: document.getElementById('coach-modal'),
                coachModalContent: document.getElementById('coach-modal-content'),
                closeCoachModalBtn: document.getElementById('close-coach-modal-btn'),
                apiKeyModal: document.getElementById('api-key-modal'),
                modalApiKeyForm: document.getElementById('modal-api-key-form'),
                modalApiKeyInput: document.getElementById('modal-api-key-input'),
                workoutModal: document.getElementById('workout-modal'),
                workoutModalContent: document.getElementById('workout-modal-content'),
                loadingOverlay: document.getElementById('loading-overlay'),
                loadingMessage: document.getElementById('loading-message'),
                errorBanner: document.getElementById('error-banner-container'),
                errorMessage: document.getElementById('error-message'),
                errorCloseBtn: document.getElementById('error-close-btn'),
            },

            init() {
                this.loadState();
                this.attachEventListeners();
                this.calculateTDEE();
                this.render();
                if (!this.state.apiKey) {
                    this.showApiKeyModal(true);
                }

                // Initialiser l'écouteur du gyroscope
                this.initGyroscope();
            },
            
            setState(newState) {
                const oldState = JSON.parse(JSON.stringify(this.state));
                
                if (newState.profile) newState.profile = {...this.state.profile, ...newState.profile};
                Object.assign(this.state, newState);
                
                if (newState.theme && newState.theme !== oldState.theme) this.renderTheme();
                if (newState.profile) {
                    this.calculateTDEE();
                    if (newState.profile.weight !== oldState.profile.weight) this.logWeight(newState.profile.weight);
                }

                this.render();
                this.saveState();
            },
            
            loadState() {
                try {
                    const savedState = JSON.parse(localStorage.getItem('vitalis-ai-state'));
                    if (savedState) {
                        this.state = { ...this.state, ...savedState };
                    }
                    this.state.apiKey = localStorage.getItem('vitalis-ai-apikey');
                    this.state.theme = localStorage.getItem('vitalis-ai-theme') || 'dark';

                    // Fusionner les programmes d'entraînement prédéfinis avec ceux qui sont sauvegardés
                    if (this.state.workoutPrograms) {
                        this.workoutPrograms = [...this.workoutPrograms, ...this.state.workoutPrograms.filter(p => !this.workoutPrograms.some(op => op.id === p.id))];
                    }

                    if (this.state.weightLog.length === 0 && this.state.profile.weight) {
                        this.logWeight(this.state.profile.weight);
                    }
                } catch (e) {
                    console.error("Failed to load state", e);
                    this.showError("Impossible de charger vos données.");
                }
            },

            saveState() {
                try {
                    const stateToSave = { ...this.state };
                    stateToSave.workoutPrograms = this.workoutPrograms.filter(p => p.id.startsWith('ai-gen-') || p.id.startsWith('manual-'));
                    localStorage.setItem('vitalis-ai-state', JSON.stringify(stateToSave));
                    if (this.state.apiKey) localStorage.setItem('vitalis-ai-apikey', this.state.apiKey);
                    localStorage.setItem('vitalis-ai-theme', this.state.theme);
                } catch (e) {
                    console.error("Failed to save state", e);
                    this.showError("Impossible de sauvegarder vos données.");
                }
            },

            attachEventListeners() {
                const { elements } = this;
                elements.navItems.forEach(item => item.addEventListener('click', () => this.setState({ activeScreen: item.dataset.screen })));
                document.body.addEventListener('click', e => {
                    const target = e.target.closest('[data-screen-target]');
                    if (target) this.setState({ activeScreen: target.dataset.screenTarget });
                });

                elements.profileForm.addEventListener('submit', e => { e.preventDefault(); this.handleProfileUpdate(); });
                elements.themeToggleBtn.addEventListener('click', () => this.setState({ theme: this.state.theme === 'dark' ? 'light' : 'dark' }));
                elements.apiKeyForm.addEventListener('submit', e => { e.preventDefault(); this.handleApiKeySave(elements.apiKeyInput.value); });
                elements.modalApiKeyForm.addEventListener('submit', e => { e.preventDefault(); this.handleApiKeySave(elements.modalApiKeyInput.value.trim(), true); });
                elements.modalApiKeyInput.addEventListener('input', e => { elements.modalApiKeyForm.querySelector('button').disabled = !e.target.value.trim(); });
                elements.errorCloseBtn.addEventListener('click', () => this.showError(null));
                elements.openCameraBtn.addEventListener('click', () => this.startCamera('nutrition'));
                elements.closeCameraBtn.addEventListener('click', () => this.stopCamera());
                elements.captureBtn.addEventListener('click', () => this.capturePhoto());
                elements.mealImageInput.addEventListener('change', e => this.handleImagePreview(e, 'nutrition'));
                elements.analyzeBtn.addEventListener('click', () => this.handleAnalyzeMeal());
                elements.manualAddForm.addEventListener('submit', e => { e.preventDefault(); this.handleManualAdd(); });
                elements.dailyCoachBtn.addEventListener('click', () => this.handleDailyCoach());
                elements.closeCoachModalBtn.addEventListener('click', () => this.showCoachModal(false));
                elements.hydrationTracker.addEventListener('click', e => {
                    if(e.target.closest('.water-glass')) {
                        const index = parseInt(e.target.closest('.water-glass').dataset.index);
                        this.setState({ hydration: { ...this.state.hydration, glasses: index + 1 } });
                    }
                });
                elements.workoutProgramList.addEventListener('click', e => {
                    const card = e.target.closest('.program-card');
                    if (card) this.showWorkoutModal(card.dataset.id);
                });

                // NOUVEAU: Événements pour la génération de programme AI
                elements.openWorkoutCameraBtn.addEventListener('click', () => this.startCamera('workout'));
                elements.workoutImageInput.addEventListener('change', e => this.handleImagePreview(e, 'workout'));
                elements.generateWorkoutBtn.addEventListener('click', () => this.handleGenerateWorkout());
            },
            
            // NOUVEAU: Fonction pour gérer le gyroscope
            initGyroscope() {
                if ('DeviceOrientationEvent' in window) {
                    window.addEventListener('deviceorientation', this.handleDeviceOrientation);
                }
            },

            handleDeviceOrientation(event) {
                const { elements } = app;
                const tiltX = event.beta; // Inclinasion de l'avant vers l'arrière
                const tiltY = event.gamma; // Inclinaison de gauche à droite
                const rotation = event.alpha; // Rotation autour de l'axe Z

                const moveX = -(tiltY / 90) * 10; // Déplacer de +/- 10%
                const moveY = -(tiltX / 90) * 10;
                
                // Pour l'effet de reflet, on utilise la rotation
                const hue = rotation || 0;

                elements.bgContainer.style.setProperty('--bg-x', `${moveX}%`);
                elements.bgContainer.style.setProperty('--bg-y', `${moveY}%`);
                elements.bgContainer.style.setProperty('--hue-rotate', `${hue}deg`);
            },


            calculateTDEE() {
                const { age, gender, height, weight, activityLevel } = this.state.profile;
                if (!age || !height || !weight) { this.state.profile.tdee = 2000; return; }
                let bmr = (gender === 'male') ? (10 * weight) + (6.25 * height) - (5 * age) + 5 : (10 * weight) + (6.25 * height) - (5 * age) - 161;
                this.state.profile.tdee = Math.round(bmr * activityLevel);
            },

            logWeight(weight) {
                const today = new Date().toISOString().split('T')[0];
                const newLog = [...this.state.weightLog];
                const todayEntryIndex = newLog.findIndex(entry => entry.date === today);
                if (todayEntryIndex > -1) newLog[todayEntryIndex].weight = weight;
                else newLog.push({ date: today, weight: weight });
                this.state.weightLog = newLog.slice(-90);
            },

            handleProfileUpdate() {
                const { elements } = this;
                const profile = {
                    age: parseInt(elements.ageInput.value), gender: elements.genderInput.value,
                    height: parseInt(elements.heightInput.value), weight: parseFloat(elements.weightInput.value),
                    targetWeight: parseFloat(elements.targetWeightInput.value), activityLevel: parseFloat(elements.activityLevelInput.value)
                };
                this.setState({ profile });
                const btn = elements.profileForm.querySelector('button');
                btn.innerHTML = `<i data-lucide="check"></i> Profil mis à jour !`;
                lucide.createIcons();
                setTimeout(() => { btn.innerHTML = `<i data-lucide="save"></i> Mettre à jour le profil`; lucide.createIcons(); }, 2000);
            },
            
            // Gérer l'aperçu de l'image pour la nutrition et l'entraînement
            handleImagePreview(event, type) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    if (type === 'nutrition') {
                        this.elements.mealImagePreview.src = e.target.result;
                        this.elements.mealImagePreview.style.display = 'block';
                        this.elements.analyzeBtn.disabled = false;
                    } else if (type === 'workout') {
                        this.elements.workoutImagePreview.src = e.target.result;
                        this.elements.workoutImagePreview.style.display = 'block';
                        this.elements.generateWorkoutBtn.disabled = false;
                    }
                };
                reader.readAsDataURL(file);
            },

            async handleAnalyzeMeal(imageData) {
                if (!this.aiService) return;
                let base64Data = imageData ? imageData.split(',')[1] : this.elements.mealImagePreview.src.split(',')[1];
                if (!base64Data) { this.showError("Veuillez d'abord sélectionner une image."); return; }
                const mealData = await this.aiService.analyzeMealImage(base64Data);
                if (mealData && mealData.name && mealData.calories) {
                    this.addMeal({ ...mealData, image: imageData || this.elements.mealImagePreview.src });
                    this.elements.mealImagePreview.style.display = 'none';
                    this.elements.analyzeBtn.disabled = true;
                    this.elements.mealImageInput.value = '';
                } else {
                    this.showError("L'IA n'a pas pu analyser le plat. Essayez l'ajout manuel.");
                }
            },

            handleManualAdd() {
                const name = document.getElementById('manual-name').value.trim();
                const calories = parseInt(document.getElementById('manual-calories').value);
                if (!name || !calories) { this.showError("Le nom et les calories sont requis."); return; }
                this.addMeal({
                    name, calories,
                    protein: parseInt(document.getElementById('manual-protein').value) || 0,
                    carbs: parseInt(document.getElementById('manual-carbs').value) || 0,
                    fat: parseInt(document.getElementById('manual-fat').value) || 0,
                });
                document.getElementById('manual-add-form').reset();
            },

            addMeal(mealData) {
                const newMeal = { id: `meal-${Date.now()}`, date: new Date().toISOString(), ...mealData };
                this.setState({ nutritionLog: [...this.state.nutritionLog, newMeal] });
            },

            // Gérer la génération de programme AI
            async handleGenerateWorkout() {
                if (!this.aiService) return;
                let base64Data = this.elements.workoutImagePreview.src.split(',')[1];
                if (!base64Data) { this.showError("Veuillez d'abord sélectionner une image de votre équipement."); return; }
                const objective = this.elements.workoutObjectiveInput.value;
                this.showLoading(true, "L'IA génère votre programme d'entraînement...");
                const workout = await this.aiService.generateWorkout(base64Data, objective);
                
                if (workout && workout.id) {
                    this.workoutPrograms.push(workout);
                    this.setState({ activeProgramId: workout.id });
                    this.elements.workoutImagePreview.style.display = 'none';
                    this.elements.generateWorkoutBtn.disabled = true;
                    this.elements.workoutImageInput.value = '';
                } else {
                    this.showError("L'IA n'a pas pu générer un programme. Assurez-vous que l'image montre de l'équipement de sport.");
                }
            },

            async handleDailyCoach() {
                if (!this.aiService) return;
                const { nutritionLog, workoutLog, profile, hydration, activeProgramId } = this.state;
                const today = new Date().toDateString();
                const todaysMeals = nutritionLog.filter(m => new Date(m.date).toDateString() === today);
                const todaysWorkout = workoutLog.find(w => new Date(w.date).toDateString() === today);

                if (todaysMeals.length === 0 && !todaysWorkout) {
                    this.showError("Ajoutez des repas ou un entraînement pour obtenir un bilan."); return;
                }
                const summary = {
                    profile: { age: profile.age, weight: profile.weight, goal: profile.tdee, targetWeight: profile.targetWeight },
                    today: {
                        calories: todaysMeals.reduce((sum, m) => sum + m.calories, 0),
                        protein: todaysMeals.reduce((sum, m) => sum + m.protein, 0),
                        carbs: todaysMeals.reduce((sum, m) => sum + m.carbs, 0),
                        fat: todaysMeals.reduce((sum, m) => sum + m.fat, 0),
                        meals: todaysMeals.map(m => m.name),
                        hydration: `${hydration.glasses}/${hydration.goal} verres`,
                        workout: todaysWorkout ? `${this.workoutPrograms.find(p=>p.id===todaysWorkout.programId).title} - ${todaysWorkout.workoutName}` : "Aucun"
                    }
                };
                this.showLoading(true, "Génération du bilan de votre coach AI...");
                const coachResponse = await this.aiService.getDailyCoach(JSON.stringify(summary));
                if (coachResponse && coachResponse.title && coachResponse.summary && coachResponse.tip) {
                    this.elements.coachModalContent.innerHTML = `
                        <h3 style="font-weight: 600; font-size: 1.1rem; margin-bottom: 0.5rem;">${coachResponse.title}</h3>
                        <p style="color: var(--color-text-secondary); margin-bottom: 1rem;">${coachResponse.summary}</p>
                        <div style="background-color: var(--color-primary-translucent); padding: 0.75rem; border-radius: 0.75rem; display: flex; align-items: center; gap: 0.75rem;">
                            <i data-lucide="award" style="color: var(--color-primary); flex-shrink: 0;"></i>
                            <p style="margin:0; font-weight: 600;">${coachResponse.tip}</p>
                        </div>`;
                    lucide.createIcons({ nodes: [this.elements.coachModalContent] });
                    this.showCoachModal(true);
                } else {
                    this.showError("Impossible de générer le bilan du coach.");
                }
            },

            handleApiKeySave(key, fromModal = false) {
                this.setState({ apiKey: key });
                if (fromModal) this.showApiKeyModal(false);
                else {
                    this.elements.apiKeyInput.value = key;
                    this.elements.saveKeyBtnText.textContent = `Enregistré!`;
                    setTimeout(() => { this.elements.saveKeyBtnText.textContent = `Sauvegarder`; }, 2000);
                }
            },
            
            // Modifier la fonction pour gérer le type de caméra (nutrition ou entraînement)
            async startCamera(type) {
                if (this.state.cameraStream) this.state.cameraStream.getTracks().forEach(track => track.stop());
                this.currentCameraType = type; // Stocker le type
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    this.state.cameraStream = stream;
                    this.elements.cameraFeed.srcObject = stream;
                    this.elements.cameraFeed.play();
                    this.elements.cameraModal.classList.add('visible');
                    lucide.createIcons({nodes: [this.elements.closeCameraBtn]});
                } catch (err) {
                    this.showError("Impossible d'accéder à la caméra. Vérifiez les autorisations.");
                }
            },
            
            stopCamera() {
                if (this.state.cameraStream) this.state.cameraStream.getTracks().forEach(track => track.stop());
                this.state.cameraStream = null;
                this.elements.cameraModal.classList.remove('visible');
            },
            
            // Modifier la fonction pour gérer la capture selon le type
            capturePhoto() {
                const { cameraFeed, cameraCanvas } = this.elements;
                const context = cameraCanvas.getContext('2d');
                cameraCanvas.width = cameraFeed.videoWidth;
                cameraCanvas.height = cameraFeed.videoHeight;
                context.drawImage(cameraFeed, 0, 0, cameraCanvas.width, cameraCanvas.height);
                this.stopCamera();
                const imageData = cameraCanvas.toDataURL('image/jpeg');
                if (this.currentCameraType === 'nutrition') {
                    this.handleAnalyzeMeal(imageData);
                } else if (this.currentCameraType === 'workout') {
                    this.elements.workoutImagePreview.src = imageData;
                    this.elements.workoutImagePreview.style.display = 'block';
                    this.elements.generateWorkoutBtn.disabled = false;
                }
            },

            aiService: {
                async run(prompt, isJson = true, imageData = null) {
                    if (!app.state.apiKey) { app.showError("Clé API non configurée."); return null; }
                    app.showLoading(true, "L'IA réfléchit...");
                    try {
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${app.state.apiKey}`;
                        const parts = [{ text: prompt }];
                        if (imageData) parts.push({ inline_data: { mime_type: "image/jpeg", data: imageData } });
                        const payload = { contents: [{ parts }], generationConfig: isJson ? { responseMimeType: "application/json" } : {} };
                        const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) { const errBody = await response.json(); throw new Error(errBody.error?.message || 'Erreur IA'); }
                        const data = await response.json();
                        const text = data.candidates[0].content.parts[0].text;
                        return isJson ? JSON.parse(text.replace(/```json\n?|```/g, '')) : text;
                    } catch (err) {
                        app.showError(`Erreur IA: ${err.message}`);
                        return null;
                    } finally {
                        app.showLoading(false);
                    }
                },
                analyzeMealImage: (base64Data) => app.aiService.run(`Vous êtes un expert en nutrition. Analysez la nourriture sur cette image. Fournissez votre meilleure estimation pour le nom du repas, le total des calories, les protéines (en grammes), les glucides (en grammes) et les lipides (en grammes). Répondez UNIQUEMENT avec un objet JSON valide au format : {"name": "string", "calories": number, "protein": number, "carbs": number, "fat": number}.`, true, base64Data),
                getDailyCoach: (summary) => app.aiService.run(`Vous êtes Vitalis AI, un coach en bien-être encourageant. Matéo, un étudiant de 18 ans, a fourni les données suivantes : ${summary}. Rédigez un bilan de sa journée en français. Soyez positif et constructif. Répondez UNIQUEMENT avec un objet JSON valide au format : {"title": "string", "summary": "string", "tip": "string"}. Le titre est un encouragement (ex: "Belle journée !"), le résumé est un bilan de 1-2 phrases sur sa nutrition et son activité, et le conseil est un conseil actionnable pour demain.`, true),
                
                // NOUVEAU: Service de génération de programme d'entraînement par IA
                generateWorkout: (base64Data, objective) => {
                    const profile = app.state.profile;
                    const prompt = `Vous êtes Vitalis AI, un coach sportif expert. Créez un programme d'entraînement pour Matéo, 18 ans, qui pèse ${profile.weight} kg et mesure ${profile.height} cm. Il a ces objectifs : "${objective}". Voici une image de son équipement :
                    
                    En fonction de l'équipement visible et de ses objectifs, créez un programme de 3 à 5 jours par semaine. Le programme doit être complet, sûr et efficace.

                    Répondez UNIQUEMENT avec un objet JSON valide au format :
                    {
                        "id": "ai-gen-${Date.now()}",
                        "title": "Nom du programme généré",
                        "description": "Une courte description du programme.",
                        "tags": [{"text": "Tag1", "class": "green"}, {"text": "Tag2", "class": "blue"}],
                        "schedule": {
                            "1": {"name": "Nom de la séance du lundi", "exercises": ["Exercice1: séries x répétitions", "Exercice2: séries x répétitions"]},
                            "2": {"name": "Nom de la séance du mardi", "exercises": ["Exercice1: séries x répétitions", "Exercice2: séries x répétitions"]},
                            ...
                        }
                    }`;
                    return app.aiService.run(prompt, true, base64Data);
                }
            },

            render() {
                const { elements, state } = this;
                elements.screens.forEach(s => s.classList.remove('active'));
                document.getElementById(`screen-${state.activeScreen}`)?.classList.add('active');

                const activeNavItem = document.querySelector(`.nav-item[data-screen="${state.activeScreen}"]`);
                if (activeNavItem) {
                    elements.navItems.forEach(item => item.classList.remove('active'));
                    activeNavItem.classList.add('active');
                    const indicator = elements.activeNavIndicator;
                    const navItemRect = activeNavItem.getBoundingClientRect();
                    const navRect = activeNavItem.parentElement.getBoundingClientRect();
                    indicator.style.transform = `translateX(${navItemRect.left - navRect.left + (navItemRect.width / 2) - (indicator.offsetWidth / 2)}px)`;
                }
                
                const renderFunc = this[`render${state.activeScreen.charAt(0).toUpperCase() + state.activeScreen.slice(1)}`];
                if (renderFunc) renderFunc.call(this);

                lucide.createIcons();
            },

            renderAccueil() {
                const { profile, nutritionLog, hydration } = this.state;
                const todaysMeals = nutritionLog.filter(m => new Date(m.date).toDateString() === new Date().toDateString());
                const totalCalories = todaysMeals.reduce((sum, m) => sum + (m.calories || 0), 0);
                const totalProtein = todaysMeals.reduce((sum, m) => sum + (m.protein || 0), 0);
                const totalCarbs = todaysMeals.reduce((sum, m) => sum + (m.carbs || 0), 0);
                const totalFat = todaysMeals.reduce((sum, m) => sum + (m.fat || 0), 0);
                
                this.elements.caloriesGoal.textContent = profile.tdee;
                this.elements.caloriesConsumed.textContent = totalCalories;
                this.elements.proteinConsumed.textContent = `${totalProtein}g`;
                this.elements.carbsConsumed.textContent = `${totalCarbs}g`;
                this.elements.fatConsumed.textContent = `${totalFat}g`;

                const progress = profile.tdee > 0 ? Math.min(1, totalCalories / profile.tdee) : 0;
                this.elements.calorieProgressFg.style.strokeDashoffset = 264 * (1 - progress);

                this.elements.hydrationTracker.innerHTML = Array.from({ length: hydration.goal }, (_, i) => 
                    `<i data-lucide="glass-water" class="water-glass ${i < hydration.glasses ? 'filled' : ''}" data-index="${i}"></i>`
                ).join('');
                this.elements.hydrationLabel.textContent = `${hydration.glasses} / ${hydration.goal} verres`;

                this.renderDailyWorkoutSummary();
            },

            renderNutrition() {
                const todaysMeals = this.state.nutritionLog.filter(m => new Date(m.date).toDateString() === new Date().toDateString());
                if (todaysMeals.length > 0) {
                    this.elements.emptyLogMessage.style.display = 'none';
                    this.elements.mealLogList.innerHTML = todaysMeals.map(meal => this.renderMealItem(meal)).join('');
                } else {
                    this.elements.emptyLogMessage.style.display = 'block';
                    this.elements.mealLogList.innerHTML = '';
                }
            },

            renderMealItem(meal) {
                const iconContent = meal.image ? `<img src="${meal.image}" alt="${meal.name}">` : `<i data-lucide="utensils-crossed"></i>`;
                return `<div class="meal-item glass-card" data-id="${meal.id}"><div class="meal-item-icon">${iconContent}</div><div class="meal-item-details"><p class="meal-item-name">${meal.name}</p><div class="meal-item-macros"><span>P: ${meal.protein || 0}g</span><span>G: ${meal.carbs || 0}g</span><span>L: ${meal.fat || 0}g</span></div></div><p class="meal-item-calories">${meal.calories || 0} <span style="font-size:0.8rem; color: var(--color-text-secondary);">kcal</span></p></div>`;
            },
            
            renderEntrainement() {
                this.elements.workoutProgramList.innerHTML = this.workoutPrograms.map(p => `
                    <div class="program-card glass-card" data-id="${p.id}">
                        <div class="program-card-header">
                            <h3 class="program-title">${p.title}</h3>
                            <div class="program-tags">${p.tags.map(t => `<span class="tag tag-${t.class}">${t.text}</span>`).join('')}</div>
                        </div>
                        <p class="program-description">${p.description}</p>
                    </div>
                `).join('');
                
                if (this.state.activeProgramId) {
                    const program = this.workoutPrograms.find(p => p.id === this.state.activeProgramId);
                    if (program) {
                        this.elements.activeProgramDisplay.innerHTML = `
                            <h2 class="section-title">Programme Actif</h2>
                            <h3 class="program-title">${program.title}</h3>
                            <p class="program-description">${program.description}</p>
                            <button class="btn btn-secondary btn-sm" style="margin-top: 0.5rem;" id="view-active-program">Voir le programme</button>
                        `;
                        this.elements.activeProgramDisplay.style.display = 'block';
                        document.getElementById('view-active-program').onclick = () => this.showWorkoutModal(this.state.activeProgramId);
                    } else {
                         this.elements.activeProgramDisplay.style.display = 'none';
                    }
                } else {
                    this.elements.activeProgramDisplay.style.display = 'none';
                }
            },

            renderProgres() {
                this.renderWeightChart();
                this.renderActivityChart();
            },

            renderWeightChart() {
                if (this.charts.weight) this.charts.weight.destroy();
                const { weightLog, profile } = this.state;
                const labels = weightLog.map(entry => new Date(entry.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }));
                const data = weightLog.map(entry => entry.weight);
                const targetWeightData = weightLog.map(() => profile.targetWeight);
                this.charts.weight = new Chart(this.elements.weightChartCanvas, this.getChartConfig(labels, [
                    { label: 'Poids', data, borderColor: 'var(--color-primary)', backgroundColor: 'var(--color-primary-translucent)' },
                    { label: 'Objectif', data: targetWeightData, borderColor: 'var(--color-secondary)', borderDash: [5, 5] }
                ]));
            },

            renderActivityChart() {
                if (this.charts.activity) this.charts.activity.destroy();
                const labels = Array.from({length: 7}, (_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    return d.toLocaleDateString('fr-FR', { weekday: 'short' });
                }).reverse();

                const data = labels.map(label => {
                    return this.state.workoutLog.filter(log => {
                        const logDate = new Date(log.date).toLocaleDateString('fr-FR', { weekday: 'short' });
                        return logDate === label;
                    }).length;
                });

                this.charts.activity = new Chart(this.elements.activityChartCanvas, this.getChartConfig(labels, [
                    { label: 'Séances', data, borderColor: 'var(--color-accent)', backgroundColor: 'rgba(245, 158, 11, 0.1)', type: 'bar' }
                ], { y: { suggestedMax: 3 } }));
            },
            
            getChartConfig(labels, datasets, scalesOptions = {}) {
                const textColor = getComputedStyle(document.documentElement).getPropertyValue('--color-text-tertiary').trim();
                const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--color-border-subtle').trim();
                return {
                    type: 'line',
                    data: { labels, datasets: datasets.map(ds => ({ fill: true, tension: 0.3, ...ds })) },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: true, labels: { color: textColor } } },
                        scales: {
                            y: { grid: { color: gridColor }, ticks: { color: textColor }, ...scalesOptions.y },
                            x: { grid: { display: false }, ticks: { color: textColor }, ...scalesOptions.x }
                        }
                    }
                };
            },

            renderProfil() {
                const { profile } = this.state;
                this.elements.ageInput.value = profile.age || '';
                this.elements.genderInput.value = profile.gender || 'male';
                this.elements.heightInput.value = profile.height || '';
                this.elements.weightInput.value = profile.weight || '';
                this.elements.targetWeightInput.value = profile.targetWeight || '';
                this.elements.activityLevelInput.value = profile.activityLevel || '1.55';
                this.elements.apiKeyInput.value = this.state.apiKey || '';
            },

            renderTheme() {
                const isDark = this.state.theme === 'dark';
                this.elements.root.className = isDark ? 'dark' : 'light';
                this.elements.themeToggleBtn.innerHTML = `<i data-lucide="${isDark ? 'sun' : 'moon'}"></i><span>Passer en ${isDark ? 'Clair' : 'Sombre'}</span>`;
                lucide.createIcons();
                if (this.state.activeScreen === 'progres') {
                    setTimeout(() => this.renderProgres(), 50);
                }
            },
            
            renderDailyWorkoutSummary() {
                const { activeProgramId, workoutLog } = this.state;
                const today = new Date();
                const dayOfWeek = today.getDay();
                const todayStr = today.toDateString();

                const todaysWorkoutCompleted = workoutLog.find(w => new Date(w.date).toDateString() === todayStr);

                if (todaysWorkoutCompleted) {
                    this.elements.dailyWorkoutSummary.innerHTML = `
                        <p style="font-weight:600; color:var(--color-primary);">Séance du jour terminée !</p>
                        <p class="text-text-secondary" style="font-size: 0.9rem;">${todaysWorkoutCompleted.workoutName}</p>
                        <i data-lucide="check-circle-2" style="color:var(--color-primary); width:48px; height:48px; margin: 0.5rem auto; display:block;"></i>
                    `;
                    return;
                }

                if (!activeProgramId) {
                    this.elements.dailyWorkoutSummary.innerHTML = `
                        <p class="text-text-secondary" style="font-size: 0.9rem;">Aucun programme sélectionné.</p>
                        <button class="btn btn-primary btn-sm" style="width:100%; margin-top: 1rem;" data-screen-target="entrainement">Choisir un programme</button>
                    `;
                    return;
                }
                
                const program = this.workoutPrograms.find(p => p.id === activeProgramId);
                const workoutForToday = program.schedule[dayOfWeek];

                if (workoutForToday) {
                    this.elements.dailyWorkoutSummary.innerHTML = `
                        <p class="text-text-secondary" style="font-size: 0.9rem;">Aujourd'hui :</p>
                        <p style="font-weight:600;">${workoutForToday.name}</p>
                        <button class="btn btn-primary btn-sm" style="width:100%; margin-top: 1rem;" id="start-today-workout">Commencer la séance</button>
                    `;
                    document.getElementById('start-today-workout').onclick = () => this.showWorkoutModal(program.id, true);
                } else {
                    this.elements.dailyWorkoutSummary.innerHTML = `
                        <p style="font-weight:600;">Jour de repos</p>
                        <p class="text-text-secondary" style="font-size: 0.9rem;">Profitez-en pour bien récupérer !</p>
                    `;
                }
            },

            showWorkoutModal(programId, startNow = false) {
                const program = this.workoutPrograms.find(p => p.id === programId);
                if (!program) return;

                const dayOfWeek = new Date().getDay();
                const workoutForToday = program.schedule[dayOfWeek];
                const isTodayWorkoutCompleted = this.state.workoutLog.some(w => new Date(w.date).toDateString() === new Date().toDateString());

                let scheduleHtml = Object.keys(program.schedule).map(day => {
                    const dayNames = ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"];
                    const workout = program.schedule[day];
                    return `
                        <div style="margin-bottom: 1rem; ${day == dayOfWeek ? 'background-color:var(--color-border-subtle); padding:0.5rem; border-radius:0.5rem;' : ''}">
                            <h4 style="font-weight:600; margin:0 0 0.5rem 0;">${dayNames[day]}: ${workout.name}</h4>
                            <ul style="list-style:none; padding-left:0; margin:0; color:var(--color-text-secondary);">
                                ${workout.exercises.map(ex => `<li>- ${ex}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }).join('');

                let actionButtonHtml = '';
                if (this.state.activeProgramId === programId) {
                    actionButtonHtml = `<button id="unselect-program-btn" class="btn btn-secondary" style="width:100%;">Changer de programme</button>`;
                } else {
                    actionButtonHtml = `<button id="select-program-btn" class="btn btn-primary" style="width:100%;">Choisir ce programme</button>`;
                }
                
                if (startNow && workoutForToday && !isTodayWorkoutCompleted) {
                    actionButtonHtml = `<button id="complete-workout-btn" class="btn btn-primary" style="width:100%;">Marquer comme terminé</button>`;
                }

                this.elements.workoutModalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="font-size:1.25rem; font-weight:bold; margin:0;">${program.title}</h2>
                        <button id="close-workout-modal-btn" style="background:none; border:none; color: var(--color-text-primary); cursor:pointer;"><i data-lucide="x"></i></button>
                    </div>
                    <div class="modal-body">
                        <p style="color:var(--color-text-secondary); margin-top:0;">${program.description}</p>
                        <h3 style="font-weight:600; margin-top:1.5rem;">Programme de la semaine</h3>
                        ${scheduleHtml}
                    </div>
                    <div style="margin-top:1.5rem;">${actionButtonHtml}</div>
                `;
                this.elements.workoutModal.classList.add('visible');
                lucide.createIcons();

                document.getElementById('close-workout-modal-btn').onclick = () => this.elements.workoutModal.classList.remove('visible');
                const selectBtn = document.getElementById('select-program-btn');
                if (selectBtn) selectBtn.onclick = () => {
                    this.setState({ activeProgramId: programId });
                    this.elements.workoutModal.classList.remove('visible');
                };
                const unselectBtn = document.getElementById('unselect-program-btn');
                if (unselectBtn) unselectBtn.onclick = () => {
                    this.setState({ activeProgramId: null });
                    this.elements.workoutModal.classList.remove('visible');
                };
                const completeBtn = document.getElementById('complete-workout-btn');
                if(completeBtn) completeBtn.onclick = () => {
                    this.setState({ workoutLog: [...this.state.workoutLog, { date: new Date().toISOString(), programId: program.id, workoutName: workoutForToday.name }] });
                    this.elements.workoutModal.classList.remove('visible');
                };
            },

            showCoachModal(visible) { this.elements.coachModal.classList.toggle('visible', visible); },
            showApiKeyModal(visible) { this.elements.apiKeyModal.classList.toggle('visible', visible); },
            showLoading(visible, message = '') {
                this.elements.loadingMessage.textContent = message;
                this.elements.loadingOverlay.classList.toggle('visible', visible);
            },
            showError(message) {
                if (message) {
                    this.elements.errorMessage.textContent = message;
                    this.elements.errorBanner.classList.add('visible');
                    clearTimeout(this.errorTimeout);
                    this.errorTimeout = setTimeout(() => this.showError(null), 5000);
                } else {
                    this.elements.errorBanner.classList.remove('visible');
                }
            },
        };

        app.init();
    });
    </script>
</body>
</html>
